# Part 0 第一类支配点对

简述：有的题目中，对答案产生影响的组合对象是一个下标二元组的形式，而所要询问的一般是一个区间内的能产生贡献的二元组的贡献的合并。

但是有的时候，一旦某个二元组被纳入考虑范围，那么一定会有另一个二元组把它的贡献盖过去。也就是说这个二元组不管需不需要被考虑，都一定不会产生贡献。这个时候我们就称后者**支配**了前者。

有些题目有性质，使得 $O(n^2)$ 级别的二元组可以通过支配关系缩减到 $O(n\log n)$ 级别。这样就可以方便地计算了。

第一类支配点对一般是树上问题，最经典的是编号区间中的所有点对两两求出 LCA，虽然点对的数量级是 $O(n^2)$，但是作为答案的 LCA 只有 $O(n)$ 个可能的取值。

解决这类问题，一般是通过树上启发式合并，每次把一个元素合并到大子树的时候，查询这个元素在大子树里面的前驱和后继，然后考虑这两个二元组的贡献。这样产生的二元组的数量级是 $O(n\log n)$ .

## Luogu7880 [Ynoi2006] rldcot

**题意**：一棵有权树，每次给出一个编号区间 $[L,R]$，求这个区间中有多少个本质不同的 $dep(lca(x,y))$，其中 $x,y\in [L,R]$ .

**做法**：考虑对答案产生贡献的组合对象是什么。是一个三元组 $(x,y,A)$ 的形式，其中 $A$ 是 $lca(x,y)$ .

接下来我们考虑，对于一个确定的 $A$，有哪些三元组会包含他。可以看出来，对于所有的**不属于** $A$ **的同一个子树的** $x,y$，他们都能产生一个三元组 $(x,y,A)$ .

而这些三元组中含有支配关系，假设 $A$ 有两个子树：$S$ 和 $T$。那么对于 $S$ 中的 $y_1 < y_2$，和 $T$ 中的一个 $x>y_2$，一定有三元组 $(y_2,x,A)$ 支配 $(y_1,x,A)$ .

> 为什么？因为 $[y_2,x]\subseteq [y_1,x]$，所以一旦一个询问区间包含了 $[y_1,x]$，它也就包含了 $[y_2,x]$ . 而二者产生的贡献是完全相同的，都为 $A$，因此我们可以完全忽略掉 $[y_1,x]$，仅考虑 $[y_2,x]$ 所产生的贡献。

所以我们只需要找到 $x$ 在另一个子树里面的前驱，剩下的都会被这个东西支配。

多个子树的情况怎么办？进行启发式合并，先把重儿子的编号集合继承过来，然后把轻儿子往里面合并，每次合并的之前，先把小子树里面的每个元素找到它在大子树里面的前驱和后继，这样可以保证正确性，每一个点对会被最后合并进来的那个唯一标记。

同理，对于 $y>x$，我们也只需要找到 $x$ 的后继。

然后就是按照上面提到的方法进行启发式合并，注意这里如滚边圈全部为 $1$，那么直接一层层合并，对于 LCA 在某一层的三元组，把他们的贡献矩形并起来，然后加到答案的 2D 平面里面。

不过这里边带权，那就把权值相同的边放在一起处理。

> 面积并怎么求？所有 2-side 矩形拉出来排个序，然后竖向切分，正常 $+1$ 就可以了。

## Luogu8528 [Ynoi2003] 铃原露露

**题意**：区间查询有多少子区间，使得子区间中所有点对的 LCA 都在这个子区间里面。

**做法**：仍然是考虑对答案做出贡献的组合对象会是什么东西，显然在这道题中它是形如 $(x,y,z)$ 的一个三元组，其中 $z = lca(x,y)$ .

接下来考虑支配关系，我们发现有点难想，所以使用补集转化，考虑有哪些三元组**不会**对答案产生贡献，显然有两种类型：

- $z <x <y$：这种形况下，所有形如 $L\in (z,x],R\in [y,+\infty)$ 的子区间都不会合法，所以要在区间平面的对应矩形上打上标记，表示这些子区间是不可用的。
- $x<y<z$：这种情况下，所有形如 $L\in[1,x],R\in[y,z)$ 的子区间都不会合法，要在对应的矩形上打标记，表示它不可用。

而最后的询问就是在区间平面上查询一个矩形内没有被覆盖的点的数目，简简单单扫描线即可。

现在的问题是找到支配关系，不然三元组的数量级是巨大的。

仿照上一题，对 $lca$ 相同的三元组放在一起讨论，发现在依次进行启发式合并的过程中（假定 $z$ 足够小，大的情况也同理），对于要合并进来的元素 $x$ 和已经合并完成的两个元素 $y_1 < y_2 < x$，能发现三元组 $(z,y_1,x)$ 标记的区域被 $(z,y_2,x)$ 完全包含。这样就找到了支配关系，和上面的一样金星启发式合并即可。

# Part 1 第二类支配点对

这种类型和商议中有一些小小的不同，比如说，这里面产生贡献的二元组 $(x,y)$ 所产生贡献的具体数值并不像上面的那一种一样，仅有 $O(n)$ 种不同的可能，而是和二元组自己的数目同阶。同时第二类中，点对有了优劣之分，而第一类中没有优劣之分。

这类支配关系一般和区间 $\min/\max$ 运算有关，其中的二元组一般代表一个区间，支配的形式是一个较大的劣区间包含了一个较小的优区间，那么一旦大区间被纳入考虑，产生真正贡献的就是包含在其中的小区间。

> 注意是大劣包含小优，不是大优包含小劣，二者的结果完全相反，前者是“一旦能考虑外面的，答案是里面的”，后者是“一旦能考虑外面的，答案还是外面的”。
> 由此可以推出，一个能够支配别人的点对，一定不被另一个人支配。换句话说，支配关系形成的树的深度只有一层。

如何有条理地找到所有的支配关系？我们可以采用前缀的思想，对于每个 $x$，求出一系列的 $y$，使得 $(x,y_1)\cdots(x,y_m)$ 这 $O(\log n)$ 个点对完全支配 $(x,x+1),(x,x+2),\cdots,(x,n)$ 这 $O(n)$ 个点对。

两种找到的方式：直接找、在分治的过程中找。

先说说直接找。首先，点对 $(i,i+1)$ 是不会被别的点对支配的，所以它是第一个支配点。然后我们令 $j$ 从 $i+2$ 开始向后遍历，直到找到不能被 $(i,i+1),(i+1,k)$ 支配的点对为止，然后继续令 $k = j+1$，继续向后找。

> 注意，要找到的点对 $(i,k)$ 不仅要不能被 $(i,j)$ 支配，也要不能被 $(j,k)$ 支配。

一个重点性质：在寻找的过程中，一个点对 $(i,k)$ 不能被上一个支配点对 $(i,j)$ 支配，当且仅当它比 $(i,j),(j,k)$ 都要优秀。

如果能利用刚刚的限制，保证每次找到之后，下一个 $k$ 的可行范围（一个值域上的范围）都会减半，那么就能成功找到 $\log n$ 个支配点。

## CF765F Souvenirs

就是，那么做啊。

## CodeChef MINXORSEG

可以看到产生答案的是点对的形式，按照刚刚的方法，固定左端点寻找右端支配点。

发现，对于 $(i,j)$ 而言，假设下一个支配点在 $(i,k)$ 这个位置，并且有 $i<j<k$ . 那么根据定义，有 $a_i\oplus a_j > a_i\oplus a_k$ 和 $a_j\oplus a_k >a_i\oplus a_k$ .

然后观察这三个数的二进制表示，并画出他们的LCP。可以观察到，只有下面的两种情况：

$$
\begin{array}{c|c|c|c|}
dgt & a_i & a_j & a_k \\
\hline
0\sim l & \cdots & \cdots & \cdots \\
l+1 & 0 & 1 & 0
\end{array}
$$
或者

$$
\begin{array}{c|c|c|c|}
dgt & a_i & a_j & a_k \\
\hline
0\sim l & \cdots & \cdots & \cdots \\
l+1 & 1 & 0 & 1
\end{array}
$$
而这会带来一个性质，每次新增一个支配点，$LCP_2(a_i,a_k)$ 就会至少向后移动一位，所以一共最多有 $O(\log n)$ 个可能的 $k$ 取值。

至于快速寻找 $k$ 的过程，可以使用 Trie 树，在上面快速寻找 $LCP_2(a_i,a_k)>LCP_2(a_i,a_j)$ 的最小的 $k$ .

## 回到主题

讲完了两道例题，接下来说说如何在一边分治的时候一边求这 $\log n$ 个支配点对。



# Part 2 杂题