# T1

结论题，可以用数学归纳法证明，最多产生贡献的只有 $\lceil\frac{n-2}{2}\rceil$ 个元素，并且他们可以随便选，所以直接贪心就行了。

# T2

这种“从一个给定的操作序列中选出一个区间，执行里面的操作”类型的题目，可以建立一颗线段树，每个节点保存一个列表 $a$，$a(x)$ 表示 “$x$ 这个元素经历该点代表的操作区间后得到的东西”。

解答询问就直接把 $\log n$ 个线段树区间拼接起来即可。

但是这一道题不方便合并，所以我们使用分块维护信息。

对操作序列 $a$ 分块，每一个块内开一个数组 $b[x]$，表示 $x$ 这个点经过了这个块里面的所有变换之后得到的位置。

如何求这个列表？先把操作序列中出现的节点建出虚树，然后向原树中所有的节点上放置一枚棋子，再按照题面给定的规则，同时移动所有的棋子，最后找到每个棋子到了什么地方。

分出两类讨论：在虚树上的、不在虚树上的。

- 在虚树上的点：考虑虚树的每一条边相当于一个 `dequeue`，只能在两端进入、弹出棋子，考虑到初始化一个块的过程中一共会移动 $\sqrt{n}$ 次，每次有 $\sqrt{n}$ 个端点需要处理，所以总时间是可以的。直接暴力模拟即可。
  
  如果一个点有多枚棋子，可以用链表以做到 $O(1)$ 弹出和压入。

- 不在虚树上的点，他们在到达虚树之前一定是朝着距离自己最近的虚树点前进，这个距离可以与处理出来，然后在合适的时机加入刚刚的 `dequeue` 中即可。

# T3

首先可以发现，整个序列可以划分成若干个连续段，每个连续段均满足 $a_{i+1} = b_{a_i}$ 这个条件。

那么我们查询一个区间 $[l,r]$ 的最长合法子区间时，答案要么在两边被截断的散段中，要么在中间的整段中。

同时发现 $b$ 数列是一个置换的形式，从一个 $a$ 中的值映射到另一个 $a$ 中的值，那么可以把它的置换环拆出来，断环为链后依次拼接到 $x$ 轴上，作为 2D 平面的第一维度。

然后考虑另外的一维，如果设置成下标的话，