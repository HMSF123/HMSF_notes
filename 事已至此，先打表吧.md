~~算了别打了对身体不好~~

# Part 0 Nim博弈

## § 0.0 定义

- “败点”：不能再继续移动棋子的状态。
- “先手必胜状态”：从这个点开始游戏，先手存在必胜策略。（又称**N态**）
- “先手必败状态”：从这个点开始游戏，后手存在必胜策略。（又称**P态**）
- “平局状态”：从这个点开始游戏，先手、后手均不存在必胜策略。

由定义可以推得：

- 任意一个必败状态的后继均为必胜状态。
- 任意一个必胜状态的后继中存在必败状态。

所有对于任意一个有向图游戏，我们可以直接通过递推的方法确定所有点的必胜/必败状态。

## § 0.1 经典异或结论的推导

思想：尝试仅依据一个点本身的信息，把每一个点的点染上两种颜色之一。要求保证所有败点均为甲色、任意一个甲色点（除败点）都**只能**移动到乙色点、任意一个乙色点都**可以**移动到甲色点。

如果存在这样一种染色方案，那么所有甲色点为**当前玩家**必败状态，所有乙色点为**当前玩家**必胜状态。

进一步可推得，如果起点为甲色，那么先手必败；反之先手必胜。

> 换言之，找到一种这样的方案，就相当于找到了一种不用递推就可以确定必胜/必败性质的方法。

对于 Nim 游戏而言，这样的方案就是：将这个点上所有石子堆的大小异或起来，如果为零染上甲色；反之染上乙色。

> 证明：
>
> 需要证明的有两部分：
>
> 1. 对于任意一个异或和非零的状态，一定存在一种操作使它的异或和变为零。
> 2. 对于任意一个异或和为零的状态，对他的任意操作都会使得异或和非零。
>
> 先证明第一种情况。
>
> 假设我们选取的元素是 $a_i$，那么要使异或和变成零，由于异或运算的自反律，我们必须把这一堆石子的数量变成 $a_i\oplus K$ . 但是 $a_i\oplus K$ 有可能比 $a_i$ 大，如何解决？
>
> 考察 $K$ 的二进制最高位，一定有奇数个 $a_k$ 的二进制数码中存在这一位。我们随便挑一个，对他进行操作。这时观察到 $a_k\oplus K$ 中，$K$ 的最高位刚好被异或掉了，所以 $a_k\oplus K<a_k$，满足条件。
>
> 利用类似的思路也可以证明第二种情况。
> 
> 假设 $a_i$ 修改后的新值是 $a'_i$，那么我们有 $a_i\oplus a_{1\sim i-1}\oplus a_{i+1\sim n} = a_i\oplus a_{1\sim i-1}\oplus a_{i+1\sim n} = 0$，即 $a_i = a_i'$，这显然是不合法的。

这样一种染色的数值也被称作**Nim和**。

### 例题1

**题意**：有 $n$ 个乌龟，每次必须选择一个正面朝上的翻转，并在此基础上选择它左侧的一个（不限正反）也翻转，最终不能操作者输。

**做法**：将乌龟从 $0$ 到 $n-1$ 编号，当前局面的Nim和就是所有正面朝上的乌龟的编号的异或和。

我们把乌龟视作值域上的桶。一个朝上的乌龟相当于一堆大小为对应编号的石子。

那么出现了两种情况：

1. 我们翻倒一个乌龟 $y$ 的同时把另一个乌龟 $x$ 回正，这相当于把一堆大小为 $y$ 的石子减少到 $x$ .
2. 我们翻倒一个乌龟 $y$ 的同时把另一个乌龟 $x$ 也翻倒，这同样也相当于把一堆大小为 $y$ 的石子减少到 $x$，只不过由于异或的自反律，我们可以直接消去这两堆相同的石子。

这启发我们，在Nim博弈中，在值域上“添加一个元素”和“删除一个元素”其实是等效的。

### 例题2

**题意**：与普通Nim游戏相同，但是进行另一种操作：从 $a_i$ 中取出任意多个石子，放到 $a_{i-1}$ 里面。并且存在 $a_0$ 这一堆石子。（显然在规则下，进入 $a_0$ 的石子无法拿出）

**解法**：这也被称为“阶梯博弈”。我们考虑下“模仿棋”，如果对方从 $a_i$ 中

# Part 1 多重有向图游戏与SG定理

## § 1.0 SG函数

我们希望用类似处理Nim博弈的方法出理一般的有向图游戏，也就需要把Nim博弈中“石子堆大小”这一概念推广。

定义 $\rm mex$ 运算为：

$$
\DeclareMathOperator{\mex}{mex}
\DeclareMathOperator{\na}{\overset{*}{+}}
\DeclareMathOperator{\nt}{\overset{*}{\times}}
\DeclareMathOperator{\SG}{SG}
\mex\{S\} = \max_{x\notin S,x\in \mathrm N}\{x\}
$$

也就是最小的、不出现在集合中的非负整数。

对于有向图游戏中的一个点 $u$，我们令

$$
\mathrm{SG}(u) = \underset{(u,v)\in E}{\operatorname{mex}}\{\mathrm{SG}(v)\}
$$

> 败点的 $SG$ 函数值为 $0$ .

那么如果有一个含有多张图、每张图配一个棋子的有向图游戏，失败条件为所有图都不能继续移动，我们有如下定理：

这个游戏先手必胜，当且仅当 $\operatorname{xor}_{i}\{\mathrm{SG}(st_i)\} = 0$ .

> 这就是**SG定理**。

为什么呢？

对于某一张图，每一次移动中，我们都可以把棋子处的 $SG$ 函数值变为任意一个小于他的非负整数，这点与 Nim 游戏中的取石子相同。

这样，多重有向图游戏中的移动操作等效于 Nim 游戏中的取石子操作，那么整个游戏可以看作一个大号的 Nim 游戏，石子堆的大小就是这张图棋子处的 $SG$ 函数取值。最后应用异或结论即可。

但是这里有一个问题，$SG(v)$ 中可能有大于 $SG(u)$ 的函数值，这会造成影响吗？

这相当于下面的两个问题：

- 这些额外的后继可能让必败状态的后继中出现必败状态吗？
- 这些额外的后继可能让必胜状态的后继全部变为必胜状态吗？

显然第二条一定是不对的，因为无论你出现多少个额外后继，都不影响 $\leq SG(u)$ 的后继的存在。

而根据刚刚在异或结论环节的推导，当且仅当 $a'_i = a_i$ 时，才能让后面的异或和仍然为零。所以第一条也是不成立的。

这样我们得出结论，对于一个有向图游戏，可以忽略掉那些 $\text{SG}(v)>\text{SG}(u)$ 的转移 $(u,v)$ .

我们也可以发现，当我们有两个平行的有向图同时进行，每次只能选择一个游戏进行操作时，现在的SG函数值等于两个游戏各自函数值的异或。

这一操作被称为**Nim和**。

> 没错，其实它和前面的Nim和是一个东西。

有时候会用下面的符号：

$$
c=a\overset{*}{+}b \Leftrightarrow SG(c) = SG(a)\oplus SG(b)
$$

一般来说大部分博弈论题目中的SG函数是直接通过打表找规律得到的。如果打表不方便，甚至可能不需要SG函数。

### 例题1

**题意**：仍然是刚才反转乌龟的游戏，但是这次可以翻转一整个从 $i-1$ 为右端点的连续段。

**做法**：没什么做法，打表找规律，发现 $SG(x) = \text{lowbit}(x)$ .

那么这是一个先手必胜的游戏。

> 这被叫做“直尺博弈”，因为它的 $SG$ 函数的图像也叫直尺函数。

### 例题2

**题意**：我们有一棵树，每次可以选择删除

### 例题3

**题意**：仍然是反转乌龟的游戏，但是这次有两个维度，每次可以翻转

## § 1.1 Nim积

刚刚我们探讨了两个**不独立**的有向图游戏的Nim和，现在来考虑两个游戏**独立**的情况。

假设我们有两个平行的有向图游戏，但是每次移动时，可以在两个游戏中择一进行，也可以都进行。这时我们可以列出下面的式子：

$$
\text{SG}(a,b) = \underset{(a,a')\in E_1,(b,b')\in E_2}{\text{mex}}\{\text{SG}(a',b),\text{SG}(a,b'),\text{SG}(a',b')\}
$$

> 这是一个类似递归的表达式。

由于“两游戏完全同时进行”经常出现，我们定义一种新的运算：Nim乘积。

$$
x\overset{*}{\times}y = \underset{0\leq x'<x,0\leq y'<y}{\text{mex}}\{x'\overset{*}{\times}y,x\overset{*}{\times}y',x'\overset{*}{\times}y'\}
$$

其中边界条件为：

- $0\nt x = 0$ .
- $1\nt x = x$ .

>这里的 $x'\overset{*}{\times}y',x\overset{*}{\times}y',x'\overset{*}{\times}y$ 都表示把两个游戏视作一体后的“大游戏”中某局面的SG函数值，$x,y,x',y'$ 表示两个组成该局面的两个“小游戏“对应的SG函数值。
>
>同时，可以证明即使能转移到 $x'>x$ 或 $y'>y$ 的后继，也不会影响结论的正确性。这被叫做 Tartan 定理。

更有趣的是，我们存在如下的定理：

$$
x\overset{*}{\times}(a\overset{*}{+}b) = (x\overset{*}{\times}a) \overset{*}{+} (x\overset{*}{\times}a)
$$

> 感性理解一下，前者的意义是：
> 
> ”你可以【在乙丙间选一个走一步】，或者在甲中走一步，也可以两个都走“
> 
> 后者的意义是：
> 
> ”你有两种选择，一种是【在乙中走一步，或者在甲中走一步，或者都走】，另一种是【在丙中走一步，或者在甲中走一步，或者都走】“
> 
> 这是等价的。

而根据我们在群论中的经验，一旦具有了**交换环**这样美好的结构，马上就要开始**群魔乱舞**了。

更加神秘的是，如果整个过程中出现的数始终在 $[0,2^{2^k})$ 的范围内，那么 Nim 积甚至存在**逆运算**，也就构成了一个**域**。

具体来说，$a^{-1} = a^{K-2},K = 2^{2^{k}}$ .

这就让一大批题目可以被量产出来。

已知的有：

- 求Nim和、Nim积意义下的行列式。
- 求Nim和、Nim积意义下的离散对数。

这些神仙科技暂且按下不表。我们来关注如何求得Nim积的具体数值。

> 这种方法与 Karatsuba 乘法类似。

定义**费马幂数**为形如 $2^{2^k},k\geq 0$ 的整数。

对于它们，有如下的结论：

$$
\begin{gathered}
N\nt 2^{2^k} = N\times 2^{2^k} \quad(N<2^{2^k})\\
2^{2^{k}} \nt 2^{2^{k}} = \frac{3}{2} 2^{2^k} \\
a,b<2^{2^k}\Rightarrow a\nt b<2^{2^k}
\end{gathered}
$$

这让我们可以用类似分治的办法求 Nim 积。设$A=a\nt 2^{2^k}\na b,B=c\nt 2^{2^k}\na d$，$k$ 是能使 $2^{2^k}< \max(A,B)$ 的最大的整数。

$$
\begin{align}
A\nt B &= (2^{2^k}a + b)\nt(2^{2^k}c+ d)\\
&= (2^{2^k}\nt a \na b)\nt(2^{2^k}\nt c\na d)\\
&= \Big(\big(2^{2^k}\big)\nt\big(2^{2^k}\big)\nt a\nt c\Big) \na
   \Big(2^{2^k}\nt a \nt d\Big) \na \Big(2^{2^k} \nt c\nt b\Big)\na
   \Big(b\nt d\Big) \\
&= \Big(\frac{3}{2}2^{2^k}\nt a\nt c\Big) \na
   2^{2^k}\nt\Big( a \nt d \na c\nt b\Big)\na
   \Big(b\nt d\Big) \\
&= \Big((2^{2^k-1}+2^{2^k})\nt a\nt c\Big) \na
   2^{2^k}\nt\Big( a \nt d \na c\nt b\Big)\na
   \Big(b\nt d\Big) \\
&= \Big((2^{2^k-1}\na2^{2^k})\nt a\nt c\Big) \na
   2^{2^k}\nt\Big( a \nt d \na c\nt b\Big)\na
   \Big(b\nt d\Big) \\
&= \Big(2^{2^k-1}\nt a\nt c\Big) \na
   2^{2^k}\nt\Big( a\nt c\Big) \na
   2^{2^k}\nt\Big( a \nt d \na c\nt b\Big)\na
   \Big(b\nt d\Big) \\
&= \Big(2^{2^k-1}\nt a\nt c\Big) \na
   2^{2^k}\nt\Big( a\nt c \na a \nt d \na c\nt b\Big)\na
   \Big(b\nt d\Big) \\
&= \Big(2^{2^k-1}\nt a\nt c\Big) \na
   2^{2^k}\Big( (a\na b)\nt(c\na d)\na b\nt d\Big)\na
   \Big(b\nt d\Big) \\
\end{align}
$$

所以我们需要计算的只有 $(a\na b)\nt(c\na d),~2^{2^k-1}\nt a\nt c,~b\nt d$ 总计四个分支。

注意到 $a,b,c,d\leq \sqrt{\max(A,B)}$ . 根据主定理，$T(n) = 4T(\sqrt{n})+\Theta(1)$，总时间复杂度为 $\Theta(\log^2 n)$ . 一般选择将 $\max(A,B)< 2^{8}$ 的值存一个表，这样可以优化常数。

我们也可以根据对数表的原理继续优化。

发现 $[0,2^{2^4})$ 这个范围内，在Nim域下有一个原根 $258$，所以我们可以预处理 Nim 积意义下的对数表和指数表，用到的时候直接查表相加，再查一次表即可。这样只需要一次递归就能求出Nim积了。

## § 1.2 其他SG变体

### MultiSG

### EverySG

多个游戏组成大游戏，但是不同的是每次只能

# Part 2 超现实数

现在讨论一下非平等博弈。



# Part 3 例题合集

感觉博弈论真的都是喵喵题。

### [AGC017 D] Game On Tree

每次删边，必然是选择根节点的一个子树，在里面删去一条边，并且不能再其他的子树里面操作第二次。

又考虑到，根节点的每一个子节点之前其实不会相互影响，所以如果根节点有 $k$ 个孩子，我们就可以把这棵树拆成 $k$ 个独立的游戏，每个游戏中的树的根节点分别只有一个孩子。

```
 O     O
 |     |
 O     O
/|\   / \
OOO   O O
:::   : :
```

也就是这个样子。

那么根据 Nim 和的结论，我们只需要把所有 $k$ 棵新树的 SG 函数值异或起来就可以了。所以问题转变成：在一棵树的顶上再连出一条单独的边，这棵树的 SG 函数值会如何变化。如果解决了这个问题，我们就可以用一次 DP 求出整棵树的 SG 函数了

考虑把博弈对应的有向图画出来。在树根（不妨称为 $v$）上新连一条边 $(u,v)$ 后，博弈图中每一个点都有了一条新的出边，连向代表【整棵树仅剩一个点 $u$】对应的局面。

> 这是因为在游戏的任意时刻，玩家都可以选择删掉边 $(u,v)$，让树中仅剩下点 $u$ .

而显然这个多出来的点的 SG 值为 $0$，那么原先博弈图中 SG 函数为 $0$ 的点们，加上连向超级汇点的边后，他们的 SG 值会变成 $1$ .

所有原先 SG 值为 $1$ 的点，其原先的所有后继的 SG 值均增加 $1$，并且新增了一个 SG 值为 $0$ 的后继，那么它的 SG 值变成 $2$ . 以此类推，每个点的后继的 SG 值整体偏移 $+1$，并且新增了一个 SG 值为 $0$ 的后继。

所以，加上边 $(u,v)$ 后，这棵树的 SG 函数值恰好增加 $1$ .

然后这道题就做完了。

### [QOJ4177] E&D

无脑打表观察题目。

这里提供一种对于分块矩阵找规律的便捷方法。

首先发现一些特殊位置上的值是可以确定的（具体来说，奇数位置上的值全部为 $0$）。

然后发现矩阵具有周期性，把 $2\times 2$ 的方格缩为一点，舍去其中为 $0$ 的部分，发现所有奇数位置的新点都是 $1$ .

依次反复类推即可找出规律。

更一般化的技巧是，面对具有周期性质的矩阵，考虑一个最小块是否能用一个值表示，如果可以的话，把这些新的值构成的新的矩阵写出来，观察是否和原阵本质同构。

### [QOJ1827] Token Game

标算没有意思，我们考虑另一种解法 。

观察发现，如果两个棋子挨在一起，那么先手必败。

> 怎么观察出来的？首先考虑最平凡的失败情况，然后考虑能不能通过模仿棋的方式把它拓展。
> 
> 具体思路为：首先观察到最终状态一定是两个棋子在最右上角，如果最后两步是模仿棋的话，那么倒数第三个局面时，两个棋子应该在棋盘的某处紧贴在一起。此时先手无论采取什么操作都不能反败为胜，遂得出结论。

更进一步可以推出，如果两个棋子位于同一行/同一列，且中间有空格，那么先手必胜。也可以推出如果有一维上两个棋子的坐标相差 $1$，那么先手必胜（因为可以直接转化为紧贴的情况）。

两者结合，即移动完毕后一维上坐标之差 $\leq 1$ 时，刚刚完成移动的玩家必败。

> 这样就排除了两个棋子紧挨的特殊情况，因为在最后一次移动前，这两个棋子肯定在某一维度上间距 $\leq 1$ .

那我们可以改换游戏条件：两棋子在棋盘上行走，途中任意时刻，两维度上两棋子的间距必须 $>1$，第一个不能移动的人输。

> 对于那些一开始就相邻的特殊情况，直接特判即可。

显然，在决出胜负之前，棋盘上两个棋子任意一维的间距都是 $>1$ 的，也就是说棋子不会相互阻挡，两个维度互不影响。

这意味着什么？无论两个棋子的 $y$ 坐标如何，任意一个棋子在 $x$ 轴上能移动的位置是不会改变的。

换句话说，如果决定在 $x$ 方向移动棋子 $A$，那么无论 $A,B$ 的纵坐标如何，【$A$ 所有能走到的位置】都是相同的。

这启示我们把游戏拆成两维。游戏的 SG 值就是两个游戏的 Nim 和。

> 为什么？
> 
> 考虑Nim和结论成立的两个条件：
> 
> 1. 每次行动玩家只能选择一个游戏走一步，不能不走也不能都走。
> 2. 大游戏失败的条件是两个子游戏中此玩家均失败。
> 
> 第一点的成立是显然的。
> 
> 对于第二点，在现在的情境中，在某一维度的子游戏中“失败”意味着：如果**下一步**走这个维度，我们只能让两棋子在这一维度上间距 $\leq 1$，从而使自己落败。
> 
> 所以只有两个维度自己都无法走下去时，才会全局失败。
> 
> 不要误认为这个游戏的“失败”是指我们**已经**让两个棋子某一维上间距 $\leq 1$，这既不符合定义，而且一旦一个维度（子游戏）发生这个情况时我们将满盘皆输。

> 这引出了一个技巧：如果两个子游戏组合后，落败条件是：“一旦有一个游戏中失败，则该玩家全局失败”。
> 
> 则我们可以把两个子游戏对应的 DAG 中所有败点剥离掉，剩下两个新的 DAG 组成一个大游戏。在这个新游戏中，落败的条件变成了适用于Nim和的“两个游戏均失败时，此玩家失败”。
> 
> 具体体现在DP上，就是禁止某些状态在DP的过程中出现。
> 
> 当然也可以处理其他获胜条件的情况，比如两个人轮流裁剪坐标纸，首先裁出 $1\times 1$ 的方格的玩家获胜（每次裁出的两张纸片均保留），那么我们可以把所有形如 $1\times n$ 设为败点，在此基础上推导 SG 。

那么对一个维度 DP，状态直接设成 $f[i,j] = \text{SG}(i,j)$ . 暴力求 $\text{mex}$ 复杂度是 $O(m^3)$ .

询问都是 $\sum_{x=1}^{x_2}\big[\text{SG}(x_1,x) = \text{SG}(y_1,y_2)\big]$ 的形式，直接 $O(nm)$ 查询即可。

成功踩标算！